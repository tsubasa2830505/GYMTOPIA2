<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ« ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</title>
    <style>
        :root {
            --gt-background: #fefffa;
            --gt-background-strong: #f9f1ea;
            --gt-primary: #e7674c;
            --gt-primary-strong: #c9563d;
            --gt-secondary: #f08e6f;
            --gt-text-main: #444949;
            --gt-text-muted: #7f837e;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            background: var(--gt-background);
            color: var(--gt-text-main);
        }
        .container {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(253, 245, 240, 0.94));
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 22px 48px -30px rgba(189, 101, 78, 0.28);
            border: 1px solid rgba(186, 122, 103, 0.22);
        }
        h1 {
            color: var(--gt-primary-strong);
            margin-bottom: 10px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid rgba(186, 122, 103, 0.22);
        }
        .success {
            background: rgba(231, 103, 76, 0.16);
            color: var(--gt-primary-strong);
        }
        .error {
            background: rgba(201, 86, 61, 0.14);
            color: var(--gt-primary-strong);
        }
        .info {
            background: rgba(240, 142, 111, 0.12);
            color: var(--gt-secondary);
        }
        .sql-box {
            background: rgba(68, 73, 73, 0.94);
            color: #fff7f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 20px 0;
        }
        button {
            background: linear-gradient(135deg, rgba(231, 103, 76, 0.96), rgba(240, 142, 111, 0.9));
            color: #fff4ef;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            box-shadow: 0 18px 36px -24px rgba(189, 101, 78, 0.36);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 22px 44px -26px rgba(189, 101, 78, 0.4);
        }
        button:disabled {
            background: rgba(231, 103, 76, 0.18);
            cursor: not-allowed;
            color: rgba(255, 240, 234, 0.8);
        }
        .log {
            background: rgba(254, 255, 250, 0.92);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid rgba(186, 122, 103, 0.18);
        }
        .log-entry {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‹ï¸ GymTopia ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ« ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h1>
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã§ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚</p>

        <div id="status" class="status info">
            æº–å‚™å®Œäº†ã€‚ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
        </div>

        <div style="margin: 20px 0;">
            <button onclick="createTable()" id="createBtn">ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ</button>
            <button onclick="testTable()" id="testBtn" disabled>ğŸ§ª ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="addSampleData()" id="sampleBtn" disabled>ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </button>
        </div>

        <div id="log" class="log"></div>

        <details style="margin-top: 30px;">
            <summary style="cursor: pointer; font-weight: bold;">æ‰‹å‹•ã§SQLã‚’å®Ÿè¡Œã™ã‚‹å ´åˆ</summary>
            <div class="sql-box">
-- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
CREATE TABLE IF NOT EXISTS check_ins (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  gym_id UUID NOT NULL REFERENCES gyms(id) ON DELETE CASCADE,
  checked_in_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  note TEXT,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_check_ins_user_id ON check_ins(user_id);
CREATE INDEX IF NOT EXISTS idx_check_ins_gym_id ON check_ins(gym_id);
CREATE INDEX IF NOT EXISTS idx_check_ins_checked_in_at ON check_ins(checked_in_at DESC);

-- RLSãƒãƒªã‚·ãƒ¼ã‚’è¨­å®š
ALTER TABLE check_ins ENABLE ROW LEVEL SECURITY;

-- æ—¢å­˜ã®ãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
DROP POLICY IF EXISTS "Users can view own check-ins" ON check_ins;
DROP POLICY IF EXISTS "Users can create own check-ins" ON check_ins;
DROP POLICY IF EXISTS "Anyone can view public check-ins" ON check_ins;

-- è‡ªåˆ†ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹
CREATE POLICY "Users can view own check-ins" ON check_ins
  FOR SELECT USING (auth.uid() = user_id OR TRUE); -- é–‹ç™ºç”¨ã«å…¨å…¬é–‹

-- è‡ªåˆ†ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ä½œæˆã§ãã‚‹
CREATE POLICY "Users can create own check-ins" ON check_ins
  FOR INSERT WITH CHECK (TRUE); -- é–‹ç™ºç”¨ã«å…¨è¨±å¯

-- å…¬é–‹ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãªã©ï¼‰ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹
CREATE POLICY "Anyone can view public check-ins" ON check_ins
  FOR SELECT USING (true);
            </div>
            <p>ğŸ‘‰ <a href="https://supabase.com/dashboard/project/htytewqvkgwyuvcsvjwm/sql/new" target="_blank">Supabase SQLã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã</a></p>
        </details>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://htytewqvkgwyuvcsvjwm.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0eXRld3F2a2d3eXV2Y3N2andtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxMzQyNDYsImV4cCI6MjA3MjcxMDI0Nn0.xltaH28adx1dIhsqaWllLDPEjw8iDrSglDIwj19rXnA';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'ğŸ“';
            entry.innerHTML = `${icon} [${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        window.createTable = async function() {
            const btn = document.getElementById('createBtn');
            btn.disabled = true;

            try {
                log('ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚’é–‹å§‹...');
                setStatus('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆä¸­...', 'info');

                // ã¾ãšæ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
                const { data: existingData, error: checkError } = await supabase
                    .from('check_ins')
                    .select('id')
                    .limit(1);

                if (!checkError || checkError.code !== 'PGRST205') {
                    log('ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™', 'success');
                    setStatus('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ—¢ã«ä½œæˆæ¸ˆã¿ã§ã™ï¼', 'success');
                    document.getElementById('testBtn').disabled = false;
                    document.getElementById('sampleBtn').disabled = false;
                    return;
                }

                // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ
                setStatus('âš ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æ‰‹å‹•ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'error');
                log('ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ä½œæˆãŒå¿…è¦ã§ã™ã€‚', 'error');
                log('ä¸Šè¨˜ã®SQLã‚’Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');

                // Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
                const link = document.createElement('a');
                link.href = 'https://supabase.com/dashboard/project/htytewqvkgwyuvcsvjwm/sql/new';
                link.target = '_blank';
                link.textContent = 'Supabase SQLã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã';
                link.style.display = 'inline-block';
                link.style.marginTop = '10px';
                link.style.color = 'var(--gt-primary)';
                document.getElementById('status').appendChild(link);

            } catch (error) {
                console.error(error);
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                setStatus('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        window.testTable = async function() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;

            try {
                log('ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‹•ä½œç¢ºèªä¸­...');
                setStatus('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™...', 'info');

                // ãƒ†ã‚¹ãƒˆ: ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Š
                const { data, error } = await supabase
                    .from('check_ins')
                    .select('*')
                    .limit(5);

                if (error) {
                    throw error;
                }

                log(`${data.length}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—`, 'success');
                setStatus('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼', 'success');

            } catch (error) {
                console.error(error);
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                setStatus('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        window.addSampleData = async function() {
            const btn = document.getElementById('sampleBtn');
            btn.disabled = true;

            try {
                log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ä¸­...');
                setStatus('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 'info');

                // ã‚¸ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const { data: gyms, error: gymsError } = await supabase
                    .from('gyms')
                    .select('id, name')
                    .limit(3);

                if (gymsError) throw gymsError;

                const demoUserId = '0ab7b9a0-fbf6-447c-9af5-ff5b12e92fa8';

                // ã‚µãƒ³ãƒ—ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
                const checkIns = [
                    {
                        user_id: demoUserId,
                        gym_id: gyms[0]?.id,
                        checked_in_at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                        note: 'æœãƒˆãƒ¬å®Œäº†ï¼æœ€é«˜ã®æ±—ã‹ã‘ãŸğŸ’ª',
                        latitude: 35.6762,
                        longitude: 139.6503
                    },
                    {
                        user_id: demoUserId,
                        gym_id: gyms[1]?.id || gyms[0]?.id,
                        checked_in_at: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                        note: 'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgé”æˆï¼ğŸ¯',
                        latitude: 35.6895,
                        longitude: 139.6917
                    }
                ];

                for (const checkIn of checkIns) {
                    const { error } = await supabase
                        .from('check_ins')
                        .insert(checkIn);

                    if (error) {
                        log(`ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    } else {
                        log(`ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä½œæˆ: ${checkIn.note}`, 'success');
                    }
                }

                setStatus('âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                log('http://localhost:3001/checkin ã§ç¢ºèªã§ãã¾ã™');

            } catch (error) {
                console.error(error);
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                setStatus('âŒ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ…‹ã‚’ç¢ºèª
        window.addEventListener('load', async () => {
            log('æ¥ç¶šç¢ºèªä¸­...');

            try {
                const { data, error } = await supabase
                    .from('check_ins')
                    .select('id')
                    .limit(1);

                if (!error || error.code !== 'PGRST205') {
                    log('ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™', 'success');
                    setStatus('âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è¨­å®šæ¸ˆã¿ã§ã™', 'success');
                    document.getElementById('testBtn').disabled = false;
                    document.getElementById('sampleBtn').disabled = false;
                } else {
                    log('ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä½œæˆãŒå¿…è¦ã§ã™ã€‚');
                }
            } catch (error) {
                log('åˆæœŸãƒã‚§ãƒƒã‚¯ä¸­ã®ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–å¯ï¼‰');
            }
        });
    </script>
</body>
</html>
