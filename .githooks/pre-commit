#!/bin/bash

# UIã®å´©ã‚Œã¨ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã®pre-commitãƒ•ãƒƒã‚¯

echo "ğŸ” é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

# é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
PROTECTED_FILES=(
    "gymtopia-app/src/app/globals.css"
    "gymtopia-app/package.json"
    "gymtopia-app/tailwind.config.js"
    "gymtopia-app/next.config.js"
)

for file in "${PROTECTED_FILES[@]}"; do
    if git diff --cached --name-only | grep -q "^$file$"; then
        echo "âš ï¸  ä¿è­·ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: $file"
        echo "ğŸ“‹ å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:"
        git diff --cached "$file"
        echo ""
        read -p "ã“ã®å¤‰æ›´ã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "âŒ ã‚³ãƒŸãƒƒãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ"
            exit 1
        fi
    fi
done

# globals.cssã®åŸºæœ¬æ§‹é€ ã‚’ãƒã‚§ãƒƒã‚¯
if git diff --cached --name-only | grep -q "gymtopia-app/src/app/globals.css"; then
    echo "ğŸ¨ globals.cssã®Tailwindè¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯
    staged_content=$(git show :gymtopia-app/src/app/globals.css 2>/dev/null || echo "")

    if [[ -n "$staged_content" ]]; then
        # å¿…è¦ãªè¦ç´ ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if ! echo "$staged_content" | grep -q '@import "tailwindcss"'; then
            echo "âŒ globals.cssã«å¿…è¦ãª @import \"tailwindcss\" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ’¡ æ­£ã—ã„å½¢å¼: @import \"tailwindcss\";"
            exit 1
        fi

        if ! echo "$staged_content" | grep -q '@theme inline'; then
            echo "âš ï¸  @theme inline ãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ’¡ ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒè¨­å®šãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 1
            fi
        fi
    fi
fi

# lintãƒã‚§ãƒƒã‚¯
if [ -f "gymtopia-app/package.json" ]; then
    echo "ğŸ” Lintãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
    cd gymtopia-app
    if npm run lint --silent; then
        echo "âœ… Lint: å•é¡Œãªã—"
    else
        echo "âŒ Lintã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        echo "ğŸ’¡ 'npm run lint' ã‚’å®Ÿè¡Œã—ã¦å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„"
        exit 1
    fi
    cd ..
fi

# TypeScriptã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
if [ -f "gymtopia-app/tsconfig.json" ]; then
    echo "ğŸ” TypeScriptã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
    cd gymtopia-app
    if npx tsc --noEmit --skipLibCheck; then
        echo "âœ… TypeScript: å•é¡Œãªã—"
    else
        echo "âŒ TypeScriptã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        echo "ğŸ’¡ ã‚¿ã‚¤ãƒ—ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„"
        exit 1
    fi
    cd ..
fi

echo "âœ… å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ã¾ã—ãŸï¼"
echo "ğŸš€ ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™..."