# 全体リファクタリング計画

## 📊 現在のコードベース分析結果

### ディレクトリ構造
```
src/
├── app/                    # Next.js App Router
│   ├── auth/              # 認証関連ページ
│   ├── admin/             # 管理者機能
│   ├── search/            # 検索機能
│   ├── profile/           # ユーザープロフィール
│   └── api/               # API Routes
├── components/            # 再利用可能コンポーネント (16ファイル、3,218行)
├── contexts/              # React Context
├── lib/                   # ユーティリティ・ビジネスロジック
│   ├── supabase/         # Supabase関連 (14ファイル)
│   ├── types/            # TypeScript型定義 (4ファイル)
│   └── mock/             # モックデータ
└── styles/               # スタイル
```

### 問題点の特定

#### 1. コンポーネントの巨大化
- `MachineSelector.tsx`: 567行 → **分割必要**
- `GymDetailModal.tsx`: 385行 → **分割必要**
- `MachineSuperDetailedSearch.tsx`: 360行 → **分割必要**

#### 2. 似たような機能の重複
- マシン検索コンポーネント群（4つ）
- マップ関連コンポーネント（4つ）

#### 3. 型定義の分散
- 型定義がファイル内に散在
- 共通型の欠如

## 🎯 リファクタリング戦略

### フェーズ1: 基盤整備 (優先度: 高)

#### 1.1 型定義の統一・強化
```
src/types/
├── index.ts           # すべての型をエクスポート
├── database.ts        # Supabaseテーブル型
├── api.ts            # API関連型
├── ui.ts             # UI共通型
└── enums.ts          # 列挙型
```

#### 1.2 ユーティリティ関数の整理
```
src/lib/
├── utils/
│   ├── index.ts      # 汎用ユーティリティ
│   ├── validation.ts # バリデーション
│   ├── format.ts     # フォーマット
│   └── constants.ts  # 定数
├── hooks/            # カスタムフック
└── services/         # ビジネスロジック
```

### フェーズ2: コンポーネント再設計 (優先度: 高)

#### 2.1 Atomic Design導入
```
src/components/
├── atoms/           # 基本要素（Button、Input等）
├── molecules/       # 組み合わせ（SearchBox、Card等）
├── organisms/       # 複合体（Header、SearchForm等）
└── templates/       # レイアウト
```

#### 2.2 巨大コンポーネントの分割
- `MachineSelector` → 検索フォーム + 結果リスト + フィルター
- `GymDetailModal` → ヘッダー + 詳細情報 + アクションボタン
- `MachineSuperDetailedSearch` → 検索条件 + 結果表示

### フェーズ3: 機能統合・最適化 (優先度: 中)

#### 3.1 検索機能の統合
- 共通検索インターフェース作成
- 検索ロジックの統一
- 結果表示コンポーネントの共通化

#### 3.2 マップ機能の統合
- 基底Mapコンポーネント作成
- 機能別Hooksで拡張
- レンダリング最適化

### フェーズ4: パフォーマンス最適化 (優先度: 中)

#### 4.1 React最適化
- `React.memo()`の適用
- `useMemo()`、`useCallback()`の導入
- 不要な再レンダリングの削減

#### 4.2 バンドル最適化
- 動的インポートの活用
- Tree shaking最適化
- 不要な依存関係の削除

### フェーズ5: 品質向上 (優先度: 低)

#### 5.1 テスト追加
- 単体テスト（Jest + Testing Library）
- 統合テスト（Playwright）
- E2Eテスト強化

#### 5.2 ドキュメント整備
- Storybookの導入
- コンポーネントドキュメント
- APIドキュメント

## 📅 実装スケジュール

### Week 1: 基盤整備
- [ ] 型定義統一
- [ ] ユーティリティ整理
- [ ] 定数・設定ファイル整理

### Week 2: コンポーネント分割
- [ ] 巨大コンポーネント分割
- [ ] Atomic Design導入
- [ ] 共通コンポーネント作成

### Week 3: 機能統合
- [ ] 検索機能統合
- [ ] マップ機能統合
- [ ] 重複削除

### Week 4: 最適化・テスト
- [ ] パフォーマンス最適化
- [ ] ビルド・テスト確認
- [ ] ドキュメント更新

## 🔧 実装ルール

### 1. 段階的移行
- 既存機能を破壊しない
- 小さな変更を積み重ね
- 各段階でテスト実行

### 2. 命名規則統一
- コンポーネント: PascalCase
- ファイル名: kebab-case
- 関数・変数: camelCase
- 定数: SCREAMING_SNAKE_CASE

### 3. TypeScript活用
- strict mode有効化
- any型の使用禁止
- 型安全性の確保

### 4. パフォーマンス考慮
- バンドルサイズ監視
- レンダリング回数最小化
- メモリリーク防止

## 🎯 成功指標

### 定量的指標
- [ ] バンドルサイズ20%削減
- [ ] 初期ロード時間30%短縮
- [ ] TypeScriptエラー0件
- [ ] ESLintエラー0件

### 定性的指標
- [ ] コード可読性向上
- [ ] 保守性向上
- [ ] 開発効率向上
- [ ] テスト容易性向上

---

**開始日**: 2025年1月13日
**完了予定**: 2025年2月10日
**担当者**: Claude Code + Tsubasa

このリファクタリングにより、コードベースの品質と保守性を大幅に向上させ、今後の開発効率を飛躍的に高めることができます。