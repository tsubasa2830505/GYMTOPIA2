# 開発ガイドライン

## AIアシスタントツール統合
このプロジェクトでは、Claude CodeとCodex（Cursor）の両方のAIアシスタントを使用しています。
どちらのツールを使用する場合も、以下のガイドラインに従ってください。

### 共通ルール
- **一貫性を保つ** - どのツールを使用しても同じコーディングスタイルとパターンを維持
- **コンテキスト共有** - 重要な変更や決定事項は`CLAUDE.md`に記録し、両ツール間で共有
- **相互補完** - 各ツールの強みを活かし、タスクに応じて適切に使い分ける

### Claude Code使用状況分析ツール
**ccusage** - Claude Codeのトークン使用量とコストを分析するCLIツール

#### インストール済み
```bash
npm install -g ccusage
```

#### 使用方法
```bash
# 日次レポート（デフォルト）
ccusage

# 月次集計
ccusage monthly

# セッション別使用量
ccusage session

# 5時間の課金ウィンドウ
ccusage blocks

# JSON形式で出力
ccusage --json

# 特定日付のフィルタリング
ccusage --date 2025-09-08
```

#### 主な機能
- リアルタイム使用量モニタリング
- モデル別トラッキング（Opus、Sonnet）
- コスト計算（USD）
- キャッシュ使用量の可視化
- 詳細なトークン使用統計

## 哲学

### 核となる信念
- **大きな変更より段階的な進歩** - コンパイルが通りテストに合格する小さな変更を行う
- **既存コードから学ぶ** - 実装前に研究し計画する
- **独断的より実用的** - プロジェクトの現実に適応する
- **巧妙なコードより明確な意図** - 退屈で明白なコードを書く

### シンプルさとは
- 関数/クラスごとに単一の責任
- 早すぎる抽象化を避ける
- 巧妙なトリックは使わない - 退屈な解決策を選ぶ
- 説明が必要なら、それは複雑すぎる

## プロセス

### 1. 計画とステージング
複雑な作業を3-5段階に分割。`IMPLEMENTATION_PLAN.md`に文書化：

```md
## ステージ N: [名前]
**目標**: [具体的な成果物]
**成功基準**: [テスト可能な結果]
**テスト**: [具体的なテストケース]
**ステータス**: [未開始|進行中|完了]
```

- 進捗に応じてステータスを更新
- すべてのステージが完了したらファイルを削除

### 2. 実装フロー
1. **理解** - コードベースの既存パターンを研究
2. **テスト** - 最初にテストを書く（レッド）
3. **実装** - テストをパスする最小限のコード（グリーン）
4. **リファクタリング** - テストをパスした状態でクリーンアップ
5. **コミット** - 計画にリンクした明確なメッセージで

### 3. 行き詰まったとき（3回試行後）
**重要**: 問題ごとに最大3回の試行、その後停止。

1. **失敗したことを文書化**：
   - 試したこと
   - 具体的なエラーメッセージ
   - 失敗したと思う理由

2. **代替案を調査**：
   - 2-3の類似実装を見つける
   - 使用された異なるアプローチをメモ

3. **基本を問い直す**：
   - これは正しい抽象化レベルか？
   - これを小さな問題に分割できるか？
   - 完全により簡単なアプローチはあるか？

4. **異なる角度から試す**：
   - 異なるライブラリ/フレームワーク機能？

## データベース設計ガイドライン（Supabase）

### ハードコーディングを避ける原則
- **環境変数の活用** - Supabase URLとAnonキーは必ず環境変数で管理
- **定数化** - テーブル名、カラム名、エラーメッセージは定数として定義
- **型定義** - データベースのスキーマに対応する型を明確に定義
- **抽象化** - データベース操作は再利用可能な関数/クラスとして実装

### 実装ルール
1. **接続情報**：
   - `.env`ファイルでSupabase URLとキーを管理
   - 本番/開発環境で異なる設定を可能に

2. **クエリ実装**：
   - SQLクエリの直書きを避ける
   - Supabaseクライアントのメソッドチェーンを活用
   - 共通操作は汎用関数として実装

3. **エラーハンドリング**：
   - データベース操作は必ずtry-catchで囲む
   - エラーメッセージは定数化
   - ユーザーフレンドリーなエラーメッセージを返す

4. **型安全性**：
   - TypeScriptの型定義を最大限活用
   - Supabaseの自動生成型を使用
   - 実行時の型チェックも実装

## バックアップ管理

### バックアップ実行ルール
**重要**: ユーザーから「バックアップして」と言われたら、必ず以下を実行：

1. **即座にGitHubへプッシュ**：
   ```bash
   git add -A
   git commit -m "バックアップ: [変更内容の説明]"
   git push origin main
   ```

2. **バージョンタグを作成**：
   ```bash
   # セマンティックバージョニングでタグ付け
   git tag -a v[major].[minor].[patch] -m "バックアップ: [バージョンの説明]"
   git push origin --tags
   ```

3. **タグ付けルール**：
   - **v1.0.0** - メジャーリリース（大きな機能追加・変更）
   - **v1.1.0** - マイナーリリース（機能追加）
   - **v1.1.1** - パッチリリース（バグ修正・小さな改善）

### バックアップ時の自動実行項目
```bash
# 1. 全変更をステージング
git add -A

# 2. コミット
git commit -m "バックアップ: v[バージョン] - [説明]"

# 3. GitHubへプッシュ
git push origin main

# 4. タグ作成
git tag -a v[バージョン] -m "[タグの説明]"

# 5. タグをプッシュ
git push origin --tags
```

### Vercelデプロイメント
- GitHubへのプッシュで自動デプロイ
- 環境変数はVercelダッシュボードで管理
- デプロイ後は必ず本番環境で動作確認