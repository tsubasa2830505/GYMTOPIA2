name: ğŸš€ Production Deployment with Health Checks

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if checks fail'
        required: false
        default: false
        type: boolean

jobs:
  # ç’°å¢ƒå¤‰æ•°ã¨è¨­å®šã®æ¤œè¨¼
  validate-environment:
    name: ğŸ” Environment Validation
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.validation.outputs.should_deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'gymtopia-app/package-lock.json'

      - name: Install Dependencies
        run: |
          cd gymtopia-app
          npm ci

      - name: Environment Variables Check
        id: validation
        run: |
          echo "Checking required environment variables..."

          # å¿…é ˆç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ç¢ºèª
          REQUIRED_VARS=(
            "NEXT_PUBLIC_SUPABASE_URL"
            "NEXT_PUBLIC_SUPABASE_ANON_KEY"
          )

          MISSING_VARS=()
          for var in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!var}" ]; then
              MISSING_VARS+=("$var")
            fi
          done

          if [ ${#MISSING_VARS[@]} -eq 0 ]; then
            echo "âœ… All required environment variables are set"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Missing environment variables: ${MISSING_VARS[*]}"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Build Test
        run: |
          cd gymtopia-app
          npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: validate-environment
    if: needs.validate-environment.outputs.should_deploy == 'true' || github.event.inputs.force_deploy == 'true'
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        id: deploy
        run: |
          npx vercel --token ${{ secrets.VERCEL_TOKEN }} --prod --yes > deployment.log 2>&1
          DEPLOYMENT_URL=$(grep -o 'https://[^[:space:]]*' deployment.log | tail -1)
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ğŸš€ Deployed to: $DEPLOYMENT_URL"

      - name: Wait for Deployment
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30

  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå¾Œã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Basic Health Check
        run: |
          DEPLOYMENT_URL="${{ needs.deploy-production.outputs.deployment_url }}"
          echo "Testing deployment at: $DEPLOYMENT_URL"

          # åŸºæœ¬çš„ãªæ¥ç¶šç¢ºèª
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$DEPLOYMENT_URL")

          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 301 ] || [ "$HTTP_STATUS" -eq 302 ]; then
            echo "âœ… Basic health check passed (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Health check failed (HTTP $HTTP_STATUS)"
            exit 1
          fi

      - name: API Endpoints Check
        run: |
          DEPLOYMENT_URL="${{ needs.deploy-production.outputs.deployment_url }}"

          # é‡è¦ãªAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
          ENDPOINTS=(
            "/api/debug-tables"
          )

          for endpoint in "${ENDPOINTS[@]}"; do
            echo "Testing $endpoint..."
            HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$DEPLOYMENT_URL$endpoint")
            echo "  Status: $HTTP_STATUS"
          done

      - name: Database Connectivity Test
        run: |
          echo "ğŸ”— Testing database connectivity..."
          DEPLOYMENT_URL="${{ needs.deploy-production.outputs.deployment_url }}"

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆdebug-tables APIçµŒç”±ï¼‰
          RESPONSE=$(curl -s "$DEPLOYMENT_URL/api/debug-tables")
          echo "Database response: $RESPONSE"

  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµæœã®é€šçŸ¥
  notify-result:
    name: ğŸ“¢ Notify Deployment Result
    runs-on: ubuntu-latest
    needs: [validate-environment, deploy-production, health-check]
    if: always()
    steps:
      - name: Create Deployment Summary
        run: |
          echo "# ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-environment.result }}" == "success" ]; then
            echo "âœ… **Environment Validation**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Environment Validation**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "âœ… **Production Deployment**: Successful" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”— **URL**: ${{ needs.deploy-production.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Production Deployment**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "âœ… **Health Check**: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Health Check**: Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # éšœå®³æ™‚ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  rollback-on-failure:
    name: ğŸ”„ Automatic Rollback
    runs-on: ubuntu-latest
    needs: [deploy-production, health-check]
    if: failure() && needs.deploy-production.result == 'success'
    steps:
      - name: Rollback Deployment
        run: |
          echo "ğŸ”„ Health check failed, initiating rollback..."
          # å‰å›ã®æˆåŠŸã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
          # npx vercel rollback --token ${{ secrets.VERCEL_TOKEN }}
          echo "âš ï¸ Automatic rollback is disabled. Manual intervention required."